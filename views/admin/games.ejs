<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('partials/head') %>
</head>
<body>

    <div class="wrapper d-flex">
        <!-- Sidebar -->
        <%- include('partials/sidebar') %>

        <!-- Page Content -->
        <div id="content">
            <!-- Top Navbar -->
            <nav class="navbar navbar-expand-lg navbar-light">
                <div class="container-fluid">
                    <button type="button" id="sidebarCollapse" class="btn btn-toggle-sidebar">
                        <i class="fas fa-align-left"></i>
                    </button>
                    <div class="ms-auto d-flex align-items-center">
                        <span class="me-3 d-none d-md-inline"><%= user.name %></span>
                        <img src="https://ui-avatars.com/api/?name=Admin&background=4e73df&color=fff" alt="Admin" class="rounded-circle" width="35">
                    </div>
                </div>
            </nav>

            <div class="container-fluid p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 class="fw-bold">Game Management</h2>
                        <p class="text-secondary">Create and manage your Matka games</p>
                    </div>
                    <button class="btn btn-primary rounded-3 px-4 py-2" data-bs-toggle="modal" data-bs-target="#gameModal">
                        <i class="fas fa-plus me-2"></i> Add New Game
                    </button>
                </div>

                <div class="card admin-table border-0">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Open Time</th>
                                        <th>Close Time</th>
                                        <th>Mid Time</th>
                                        <th>Max Bet After Mid</th>
                                        <th>Status</th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% 
                                    function calculateStatus(closeTime) {
                                        const now = new Date();
                                        const currentTimeStr = now.getHours().toString().padStart(2, '0') + ':' + 
                                                             now.getMinutes().toString().padStart(2, '0') + ':' + 
                                                             now.getSeconds().toString().padStart(2, '0');
                                        return currentTimeStr < closeTime;
                                    }
                                    
                                    games.forEach(game => { 
                                        const isOpen = calculateStatus(game.close_time);
                                    %>
                                        <tr>
                                            <td class="fw-600"><%= game.name %></td>
                                            <td><%= game.open_time %></td>
                                            <td><%= game.close_time %></td>
                                            <td><%= game.mid_time || '-' %></td>
                                            <td>â‚¹<%= game.max_bet_after_mid_time || '-' %></td>
                                            <td>
                                                <% if (game.is_active) { %>
                                                    <% if (isOpen) { %>
                                                        <span class="badge bg-success-subtle text-success border border-success-subtle px-3 py-2 rounded-pill">Open</span>
                                                    <% } else { %>
                                                        <span class="badge bg-danger-subtle text-danger border border-danger-subtle px-3 py-2 rounded-pill">Closed</span>
                                                    <% } %>
                                                <% } else { %>
                                                    <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle px-3 py-2 rounded-pill">Inactive</span>
                                                <% } %>
                                            </td>
                                            <td class="text-end">
                                                <button class="btn btn-sm btn-outline-primary rounded-pill px-3 me-2 edit-game" 
                                                        data-game="<%= JSON.stringify(game) %>">
                                                    <i class="fas fa-edit me-1"></i> Edit
                                                </button>
                                                <button class="btn btn-sm btn-outline-<%= game.is_active ? 'danger' : 'success' %> rounded-pill px-3 toggle-status" 
                                                        data-id="<%= game.id %>" data-status="<%= game.is_active %>">
                                                    <i class="fas fa-power-off me-1"></i> <%= game.is_active ? 'Deactivate' : 'Activate' %>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger rounded-pill px-3 ms-2 delete-game" 
                                                        data-id="<%= game.id %>">
                                                    <i class="fas fa-trash me-1"></i> Delete
                                                </button>
                                            </td>
                                        </tr>
                                    <% }); %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Game Modal -->
    <div class="modal fade" id="gameModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 rounded-4 shadow">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold" id="modalTitle">Add New Game</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="gameForm">
                    <div class="modal-body p-4">
                        <input type="hidden" id="gameId" name="id">
                        <div class="mb-3">
                            <label class="form-label fw-600">Game Name</label>
                            <input type="text" class="form-control rounded-3" id="gameName" name="name" required placeholder="e.g. TAJ MORNING">
                        </div>
                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="form-label fw-600">Open Time</label>
                                <input type="time" class="form-control rounded-3" id="openTime" name="openTime" required>
                            </div>
                            <div class="col-6">
                                <label class="form-label fw-600">Close Time</label>
                                <input type="time" class="form-control rounded-3" id="closeTime" name="closeTime" required>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="form-label fw-600">Mid Time <small class="text-muted">(Optional)</small></label>
                                <input type="time" class="form-control rounded-3" id="midTime" name="midTime" placeholder="HH:MM">
                                <small class="text-muted">Time after which max bet limit applies</small>
                            </div>
                            <div class="col-6">
                                <label class="form-label fw-600">Max Bet After Mid Time</label>
                                <input type="number" class="form-control rounded-3" id="maxBetAfterMidTime" name="maxBetAfterMidTime" value="100" step="0.01" min="0" placeholder="100.00">
                                <small class="text-muted">Maximum bet amount after mid time</small>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer border-0 pt-0 pb-4 px-4">
                        <button type="button" class="btn btn-light rounded-3 px-4" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary rounded-3 px-4" id="saveBtn">Save Game</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <%- include('partials/scripts') %>

    <script>
        const gameModal = new bootstrap.Modal(document.getElementById('gameModal'));
        const gameForm = document.getElementById('gameForm');
        
        // Edit Game
        document.querySelectorAll('.edit-game').forEach(btn => {
            btn.addEventListener('click', () => {
                const game = JSON.parse(btn.getAttribute('data-game'));
                document.getElementById('modalTitle').textContent = 'Edit Game';
                document.getElementById('gameId').value = game.id;
                document.getElementById('gameName').value = game.name;
                
                // Ensure time is in HH:MM format for <input type="time">
                const formatTime = (t) => t ? t.substring(0, 5) : "";
                
                document.getElementById('openTime').value = formatTime(game.open_time);
                document.getElementById('closeTime').value = formatTime(game.close_time);
                document.getElementById('midTime').value = formatTime(game.mid_time);
                document.getElementById('maxBetAfterMidTime').value = game.max_bet_after_mid_time || 100;
                gameModal.show();
            });
        });

        // Add Game Button Reset
        document.querySelector('[data-bs-target="#gameModal"]').addEventListener('click', () => {
            document.getElementById('modalTitle').textContent = 'Add New Game';
            gameForm.reset();
            document.getElementById('gameId').value = '';
        });

        // Handle Form Submission
        gameForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(gameForm);
            const data = Object.fromEntries(formData.entries());
            const isEdit = data.id !== '';
            
            // Clean up data - convert empty strings to null for optional fields
            if (!data.midTime || data.midTime.trim() === '') {
                data.midTime = null;
            }
            
            // Convert maxBetAfterMidTime to number
            if (data.maxBetAfterMidTime) {
                data.maxBetAfterMidTime = parseFloat(data.maxBetAfterMidTime);
            }
            
            const url = isEdit ? `/api/games/${data.id}` : '/api/games';
            const method = isEdit ? 'PUT' : 'POST';
            
            try {
                await apiCall(url, method, data);
                Swal.fire({
                    icon: 'success',
                    title: 'Success',
                    text: `Game ${isEdit ? 'updated' : 'created'} successfully`,
                    timer: 1500
                }).then(() => location.reload());
            } catch (err) {}
        });

        // Toggle Status
        document.querySelectorAll('.toggle-status').forEach(btn => {
            btn.addEventListener('click', async () => {
                const id = btn.dataset.id;
                const currentStatus = btn.dataset.status === 'true';
                
                try {
                    await apiCall(`/api/games/${id}`, 'PUT', { isActive: !currentStatus });
                    location.reload();
                } catch (err) {}
            });
        });

        // Delete Game
        document.querySelectorAll('.delete-game').forEach(btn => {
            btn.addEventListener('click', async () => {
                const id = btn.dataset.id;
                
                const result = await Swal.fire({
                    title: 'Are you sure?',
                    text: "You won't be able to revert this! This will permanently delete the game.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, delete it!'
                });

                if (result.isConfirmed) {
                    try {
                        await apiCall(`/api/games/${id}`, 'DELETE');
                        Swal.fire(
                            'Deleted!',
                            'Game has been deleted.',
                            'success'
                        ).then(() => location.reload());
                    } catch (err) {
                        console.error(err);
                        Swal.fire(
                            'Error!',
                            'Failed to delete game. It might have associated data.',
                            'error'
                        );
                    }
                }
            });
        });
    </script>
</body>
</html>
