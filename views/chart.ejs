<% 
const currentPage = 'chart';
const title = 'Chart';
%>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title><%= title %> - Taj Matka</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="mobile-container">
        
        <!-- Fixed Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="header-left">
                    <button class="menu-btn" onclick="window.history.back()">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="19" y1="12" x2="5" y2="12"></line>
                            <polyline points="12 19 5 12 12 5"></polyline>
                        </svg>
                    </button>
                    <h1 class="app-logo">CHART</h1>
                </div>
                <div class="header-right">
                    <div class="wallet-balance" id="walletBalance" onclick="window.location.href='/wallet'" style="cursor: pointer;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="5" width="20" height="14" rx="2"></rect>
                            <line x1="2" y1="10" x2="22" y2="10"></line>
                        </svg>
                        <span id="balanceAmount">â‚¹0</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="app-main">
            <div class="page-content">
                
                <!-- Chart Container -->
                <div class="chart-container" style="background: var(--bg-card); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                    
                    <!-- Loading State -->
                    <div id="chartLoading" style="text-align: center; padding: 3rem;">
                        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;">
                            <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
                        </svg>
                        <p style="margin-top: 1rem; color: #666;">Loading Chart...</p>
                    </div>

                    <!-- Chart Content -->
                    <div id="chartContent" style="display: none;">
                        <div class="table-responsive" style="overflow-x: auto;">
                            <table class="chart-table" style="width: 100%; border-collapse: collapse; min-width: 600px;">
                                <thead style="background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); color: #D4AF37;">
                                    <tr>
                                        <th style="padding: 1rem; text-align: left; position: sticky; left: 0; background: #2d2d2d; z-index: 2; border-bottom: 2px solid #D4AF37;">Date</th>
                                        <!-- Game Headers will be injected here -->
                                    </tr>
                                </thead>
                                <tbody id="chartBody">
                                    <!-- Rows will be injected here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div id="chartEmpty" style="display: none; text-align: center; padding: 3rem;">
                        <p style="color: #666;">No chart data available yet.</p>
                    </div>

                </div>

                <style>
                    @keyframes spin { 100% { transform: rotate(360deg); } }
                    
                    .chart-table th, .chart-table td {
                        padding: 1rem;
                        text-align: center;
                        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                    }
                    
                    .chart-table th:first-child, .chart-table td:first-child {
                        text-align: left;
                        font-weight: bold;
                        color: #D4AF37;
                        position: sticky;
                        left: 0;
                        background: var(--bg-card); /* Matches card bg to cover scrolling content */
                        z-index: 1;
                        border-right: 1px solid rgba(255, 255, 255, 0.1);
                    }

                    .chart-table tr:nth-child(even) {
                        background-color: rgba(255, 255, 255, 0.02);
                    }
                    
                    .chart-table tr:hover {
                        background-color: rgba(212, 175, 55, 0.05);
                    }

                    .chart-cell-result {
                        font-family: 'Courier New', monospace;
                        font-weight: bold;
                        font-size: 1.1rem;
                        color: #fff;
                    }

                    .chart-date {
                        white-space: nowrap;
                        font-size: 0.9rem;
                    }
                </style>

            </div>
        </main>

        <!-- Bottom Navigation -->
         <nav class="bottom-nav">
            <a href="/results" class="nav-item">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                    <path d="M2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
                <span>Results</span>
            </a>
            <a href="/history" class="nav-item">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                </svg>
                <span>History</span>
            </a>
            <a href="/home" class="nav-item nav-item-home">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    <polyline points="9 22 9 12 15 12 15 22" stroke="var(--bg-primary)" stroke-width="2" fill="none"/>
                </svg>
                <span>Home</span>
            </a>
            <a href="/chart" class="nav-item active">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="20" x2="18" y2="10"/>
                    <line x1="12" y1="20" x2="12" y2="4"/>
                    <line x1="6" y1="20" x2="6" y2="14"/>
                </svg>
                <span>Chart</span>
            </a>
            <a href="#" class="nav-item" onclick="shareApp(); return false;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="18" cy="5" r="3"/>
                    <circle cx="6" cy="12" r="3"/>
                    <circle cx="18" cy="19" r="3"/>
                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                    <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                </svg>
                <span>Share</span>
            </a>
        </nav>

    </div>

    <!-- Scripts -->
    <script src="/js/app.js"></script>
    <script>
        if (isLoggedIn()) {
            loadUserBalance();
        }

        async function fetchChartData() {
            const loading = document.getElementById('chartLoading');
            const content = document.getElementById('chartContent');
            const empty = document.getElementById('chartEmpty');
            
            try {
                const response = await fetch('/api/games/chart-data');
                const result = await response.json();
                
                loading.style.display = 'none';
                
                if (result.success && result.data.chartData && result.data.chartData.length > 0) {
                    renderChart(result.data);
                    content.style.display = 'block';
                } else {
                    empty.style.display = 'block';
                }
            } catch (error) {
                console.error('Error fetching chart data:', error);
                loading.style.display = 'none';
                empty.style.display = 'block';
                empty.innerHTML = '<p style="color: #ff4444;">Failed to load chart data.</p>';
            }
        }

        function renderChart(data) {
            const { games, chartData } = data;
            const tableHead = document.querySelector('.chart-table thead tr');
            const tableBody = document.getElementById('chartBody');
            
            // 1. Render Headers
            games.forEach(game => {
                const th = document.createElement('th');
                th.textContent = game.name;
                th.style.color = '#fff';
                tableHead.appendChild(th);
            });
            
            // 2. Render Rows
            tableBody.innerHTML = chartData.map(row => {
                const dateObj = new Date(row.date);
                const dateStr = dateObj.toLocaleDateString('en-IN', {
                    day: '2-digit',
                    month: 'short'
                });
                
                let rowHtml = `
                    <tr>
                        <td class="chart-date">${dateStr}</td>
                `;
                
                games.forEach(game => {
                    const result = row.results[game.id];
                    rowHtml += `
                        <td class="chart-cell-result">
                            ${result !== undefined ? `<span style="color: #00ff88;">${result}</span>` : '<span style="color: #444;">--</span>'}
                        </td>
                    `;
                });
                
                rowHtml += '</tr>';
                return rowHtml;
            }).join('');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', fetchChartData);
    </script>
</body>
</html>
