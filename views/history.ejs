<% 
const currentPage = 'history';
const title = 'Bet History';
%>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title><%= title %> - Taj Matka</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <div class="mobile-container">
        
        <!-- Fixed Header -->
        <header class="app-header">
            <div class="header-content">
                <div class="header-left">
                    <button class="menu-btn" onclick="window.history.back()">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="19" y1="12" x2="5" y2="12"></line>
                            <polyline points="12 19 5 12 12 5"></polyline>
                        </svg>
                    </button>
                    <h1 class="app-logo">BET HISTORY</h1>
                </div>
                <div class="header-right">
                    <div class="wallet-balance" id="walletBalance">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="5" width="20" height="14" rx="2"></rect>
                            <line x1="2" y1="10" x2="22" y2="10"></line>
                        </svg>
                        <span id="balanceAmount">₹0</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="app-main">
            <div class="page-content">
                
                <!-- Filter Tabs -->
                <div class="betting-tabs" style="margin-bottom: 1rem;">
                    <button class="tab-btn active" data-filter="all" onclick="filterBets('all')">All</button>
                    <button class="tab-btn" data-filter="pending" onclick="filterBets('pending')">Pending</button>
                    <button class="tab-btn" data-filter="win" onclick="filterBets('win')">Won</button>
                    <button class="tab-btn" data-filter="loss" onclick="filterBets('loss')">Lost</button>
                </div>

                <!-- Bets List -->
                <div id="betsList">
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        Loading bets...
                    </div>
                </div>

            </div>
        </main>

        <!-- Bottom Navigation -->
         <nav class="bottom-nav">
            <a href="/results" class="nav-item">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                    <path d="M2 17l10 5 10-5M2 12l10 5 10-5"/>
                </svg>
                <span>Results</span>
            </a>
            <a href="/history" class="nav-item active">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <polyline points="12 6 12 12 16 14"/>
                </svg>
                <span>History</span>
            </a>
            <a href="/home" class="nav-item nav-item-home">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    <polyline points="9 22 9 12 15 12 15 22" stroke="var(--bg-primary)" stroke-width="2" fill="none"/>
                </svg>
                <span>Home</span>
            </a>
            <a href="/chart" class="nav-item">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="20" x2="18" y2="10"/>
                    <line x1="12" y1="20" x2="12" y2="4"/>
                    <line x1="6" y1="20" x2="6" y2="14"/>
                </svg>
                <span>Chart</span>
            </a>
            <a href="#" class="nav-item" onclick="shareApp(); return false;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="18" cy="5" r="3"/>
                    <circle cx="6" cy="12" r="3"/>
                    <circle cx="18" cy="19" r="3"/>
                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                    <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                </svg>
                <span>Share</span>
            </a>
        </nav>

    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="/js/app.js"></script>
    <script>
        let allBets = [];
        let currentFilter = 'all';

        // Load bet history
        async function loadBets() {
            if (!isLoggedIn()) {
                window.location.href = '/login';
                return;
            }

            try {
                const response = await API.get('/bets/history?limit=100');
                if (response.success) {
                    allBets = response.data;
                    renderBets();
                }
            } catch (error) {
                console.error('Error loading bets:', error);
                document.getElementById('betsList').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #ff4444;">
                        Failed to load bets
                    </div>
                `;
            }
        }

        // Filter bets
        function filterBets(filter) {
            currentFilter = filter;
            
            // Update active tab
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.getAttribute('data-filter') === filter) {
                    btn.classList.add('active');
                }
            });
            
            renderBets();
        }

        // Render bets
        function renderBets() {
            let filteredBets = allBets;
            
            if (currentFilter !== 'all') {
                filteredBets = allBets.filter(bet => bet.status === currentFilter);
            }
            
            if (filteredBets.length === 0) {
                document.getElementById('betsList').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        No ${currentFilter === 'all' ? '' : currentFilter} bets found
                    </div>
                `;
                return;
            }
            
            const html = filteredBets.map(bet => {
                const status = bet.status;
                const statusColor = status === 'win' ? '#00ff88' : 
                                   status === 'loss' ? '#ff4444' : '#ffaa00';
                const statusText = status === 'win' ? 'WON' : 
                                  status === 'loss' ? 'LOST' : 'PENDING';
                
                const date = new Date(bet.created_at);
                const dateStr = date.toLocaleDateString('en-IN', { day: '2-digit', month: 'short' });
                const timeStr = date.toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' });
                
                // Format bet type
                const formattedType = bet.bet_type.replace('_', ' ').toUpperCase();
                
                return `
                    <div style="background: var(--bg-card); padding: 1.25rem; border-radius: 16px; margin-bottom: 1rem; border-left: 4px solid ${statusColor}; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                            <div>
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem;">
                                    <div style="font-weight: 700; font-size: 1.2rem; color: #FF4500;">${bet.bet_number}</div>
                                    <div style="background: rgba(255, 69, 0, 0.1); color: #FF4500; padding: 0.1rem 0.5rem; border-radius: 4px; font-size: 0.65rem; font-weight: 700;">${formattedType}</div>
                                </div>
                                <div style="font-size: 0.875rem; color: var(--text-secondary); font-weight: 500;">${bet.game_name}</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 700; color: ${statusColor}; font-size: 0.9rem;">${statusText}</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">${dateStr}, ${timeStr}</div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; padding: 1rem; background: var(--bg-input); border-radius: 12px;">
                            <div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Bet Amount</div>
                                <div style="font-weight: 700; font-size: 1.1rem;">₹${parseFloat(bet.bet_amount).toFixed(2)}</div>
                            </div>
                            
                            ${status === 'win' ? `
                                <div style="text-align: right;">
                                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Winning Amount</div>
                                    <div style="font-weight: 800; font-size: 1.1rem; color: #00ff88;">+ ₹${parseFloat(bet.payout_amount || 0).toFixed(2)}</div>
                                </div>
                            ` : (bet.winning_number ? `
                                <div style="text-align: right;">
                                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Winning Result</div>
                                    <div style="font-weight: 700; font-size: 1.1rem; color: var(--text-primary);">${bet.winning_number}</div>
                                </div>
                            ` : `
                                <div style="text-align: right;">
                                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Result Date</div>
                                    <div style="font-weight: 600; font-size: 0.9rem;">${bet.session_date ? new Date(bet.session_date).toLocaleDateString('en-IN', { day: '2-digit', month: 'short' }) : 'Today'}</div>
                                </div>
                            `)}
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('betsList').innerHTML = html;
        }

        // Load bets on page load
        loadBets();
        
        // Load balance
        if (isLoggedIn()) {
            loadUserBalance();
        }

        // Make filterBets global
        window.filterBets = filterBets;
    </script>
</body>
</html>
